---
- name: Ensure deploy user exists
  user:
    name: deploy

- name: Create gpii-ci-ssh/
  file:
    path: /home/deploy/gpii-ci-ssh
    state: directory
    owner: deploy
    group: deploy
    mode: 0700

- name: Configure gpii-ci-ssh/known_hosts
  copy:
    src: files/ssh_known_hosts
    dest: /home/deploy/gpii-ci-ssh/known_hosts
    owner: deploy
    group: deploy
    mode: 0644
    backup: yes

- name: Configure gpii-ci-ssh/config
  copy:
    src: files/ssh_config
    dest: /home/deploy/gpii-ci-ssh/config
    owner: deploy
    group: deploy
    mode: 0644

- name: Force pull version-updater image
  docker_image:
    name: gpii/version-updater:latest
    force: yes

- name: Run version-updater container
  docker_container:
    name: version-updater
    image: gpii/version-updater:latest
    state: started
    restart: yes
    restart_policy: always
    volumes:
      - /home/deploy/gpii-ci-ssh/id_rsa.gpii-ci:/root/.ssh/id_rsa.gpii-ci:ro,Z
      - /home/deploy/gpii-ci-ssh/known_hosts:/root/.ssh/known_hosts:ro,Z
